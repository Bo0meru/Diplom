{% extends 'home/base.html' %}

{% block content %}
<h1>Редактировать вопрос</h1>
<form method="post" class="edit-form">
    {% csrf_token %}
    <div class="question-form">
        {{ form.as_p }}
    </div>
    <h2>Ответы</h2>
    <div class="answers-form">
        {{ formset.management_form }}
        {% for form in formset %}
            <div class="answer-form">
                {{ form.as_p }}
                {% if form.instance.pk %}
                    <p><a href="javascript:void(0);" class="delete-form" data-form-id="{{ form.prefix }}">Удалить</a></p>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    <button type="submit" class="btn btn-primary">Сохранить</button>
</form>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script>
    document.querySelectorAll('.delete-form').forEach(button => {
        button.addEventListener('click', function() {
            var formId = this.getAttribute('data-form-id');
            document.querySelector(`[name="${formId}-DELETE"]`).checked = true;
            this.closest('.answer-form').style.display = 'none';
        });
    });

    // Функция для автоматического изменения высоты textarea
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto'; // Сброс высоты для правильного расчета scrollHeight
        textarea.style.height = Math.min(textarea.scrollHeight, textarea.style.minHeight.replace('px', '')) + 'px'; // Установка высоты по содержимому или минимальной высоте
    }

    // Применение функции ко всем textarea при загрузке страницы и при вводе текста
    document.querySelectorAll('textarea').forEach(textarea => {
        autoResizeTextarea(textarea);
        textarea.addEventListener('input', function() {
            autoResizeTextarea(this);
        });
    });

    // Инициализация select2 для тегов
    $(document).ready(function() {
        $('.django-select2').select2({
            tags: true,
            tokenSeparators: [',', ' '],
            placeholder: 'Выберите или создайте метки',
            allowClear: true,
            width: '100%'  // Устанавливаем ширину на 100%
        });

        // Установите текущие метки в виджете select2
        var initialTags = {{ tags | safe }};
        $('.django-select2').val(initialTags).trigger('change');
    });
</script>
{% endblock %}
