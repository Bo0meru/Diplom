{% extends 'home/base.html' %}

{% block content %}
<header class="header">
    <h1>Панель управления</h1>
</header>
<div class="search-bar">
    <form id="search-form" method="get" action="">
        <input type="text" name="q" placeholder="Поиск по ключевым словам или меткам" value="{{ request.GET.q }}" class="search-input">
        <input type="hidden" name="selected_ids" id="selected-ids" value="{{ request.GET.selected_ids }}">
        <button type="submit" class="btn btn-primary">Поиск</button>
    </form>
</div>
<div class="main-content">
    <div class="navigation">
        {% if current_page == 'questions' %}
            <a href="{% url 'create_question' %}" class="btn btn-secondary">Создать новый вопрос</a>
            <button id="export-btn" class="btn btn-secondary">Выгрузить</button>
        {% elif current_page == 'documents' %}
            <a href="{% url 'upload_document' %}" class="btn btn-secondary">Загрузить новый документ</a>
            <button id="export-btn" class="btn btn-secondary">Выгрузить</button>
        {% endif %}
        <a href="{% url 'tag_list' %}" class="btn btn-secondary">Доступные теги</a>
    </div>
    <div id="search-results">
        {% block dashboard_content %}
        {% endblock %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function initializeDragAndDrop(itemClass, sourceContainerId, targetContainerId) {
            const items = document.querySelectorAll(itemClass);
            const sourceContainer = document.getElementById(sourceContainerId);
            const targetContainer = document.getElementById(targetContainerId);
            const exportBtn = document.getElementById('export-btn');

            const newExportBtn = exportBtn.cloneNode(true);
            exportBtn.parentNode.replaceChild(newExportBtn, exportBtn);

            if (!items.length) {
                console.log('Items not found:', itemClass);
                return;
            }
            if (!sourceContainer || !targetContainer) {
                console.log('Container not found:', sourceContainerId, targetContainerId);
                return;
            }

            const originalPositions = Array.from(sourceContainer.children).map(child => child.id);
            console.log('Original positions:', originalPositions);

            items.forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', item.dataset.id);
                    e.dataTransfer.effectAllowed = 'move';
                    item.classList.add('dragging');
                    console.log('Drag started:', item);
                });

                item.addEventListener('dragend', function(e) {
                    item.classList.remove('dragging');
                    console.log('Drag ended:', item);
                });

                item.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    console.log('Drag enter:', item);
                });

                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    console.log('Drag over:', item);
                });

                item.addEventListener('dragleave', function(e) {
                    console.log('Drag leave:', item);
                });
            });

            [sourceContainer, targetContainer].forEach(container => {
                container.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    console.log('Drag over container:', container.id);
                });

                container.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const id = e.dataTransfer.getData('text/plain');
                    const item = document.querySelector(`${itemClass}[data-id="${id}"]`);
                    console.log('Drop event:', item, 'in container:', container.id);
                    if (item && !document.querySelector(`#${container.id} ${itemClass}[data-id="${id}"]`)) {
                        const clonedItem = item.cloneNode(true);
                        clonedItem.classList.remove('dragging');
                        clonedItem.setAttribute('draggable', true);
                        container.appendChild(clonedItem);
                        item.remove();
                        console.log('Item cloned and added to container, and original item removed:', container.id);

                        initializeDragAndDrop(itemClass, sourceContainerId, targetContainerId);

                        if (container.id === sourceContainerId) {
                            const children = Array.from(container.children);
                            children.sort((a, b) => originalPositions.indexOf(a.id) - originalPositions.indexOf(b.id));
                            children.forEach(child => container.appendChild(child));
                            console.log('Restored original order for source container:', originalPositions);
                        }

                        saveSelectedQuestions();
                    }
                });
            });

            newExportBtn.addEventListener('click', function() {
                const selectedIds = Array.from(targetContainer.querySelectorAll(itemClass)).map(item => item.dataset.id);
                const exportUrl = targetContainerId === 'selected-questions' ? '{% url "export_questions" %}' : '{% url "export_documents" %}';
                fetch(exportUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ids: selectedIds})
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = targetContainerId === 'selected-questions' ? 'selected_questions.docx' : 'selected_documents.zip';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    console.log('File downloaded:', a.download);
                })
                .catch(error => console.error('Error:', error));
            });
        }

        function saveSelectedQuestions() {
            const selectedQuestions = Array.from(document.getElementById('selected-questions').children).map(item => item.dataset.id);
            document.getElementById('selected-ids').value = selectedQuestions.join(',');
            console.log('Selected questions saved to hidden field:', selectedQuestions);
        }

        function restoreSelectedQuestions() {
            const selectedIdsValue = document.getElementById('selected-ids').value;
            const selectedQuestions = selectedIdsValue ? selectedIdsValue.split(',') : [];
            const availableQuestions = document.getElementById('available-questions');
            const selectedContainer = document.getElementById('selected-questions');

            selectedQuestions.forEach(id => {
                const item = availableQuestions.querySelector(`.question[data-id="${id}"]`);
                if (item) {
                    const clonedItem = item.cloneNode(true);
                    clonedItem.classList.remove('dragging');
                    clonedItem.setAttribute('draggable', true);
                    selectedContainer.appendChild(clonedItem);
                    item.remove();
                    console.log('Restored selected question:', id);
                }
            });

            initializeDragAndDrop('.question', 'available-questions', 'selected-questions');
        }

        function performSearch(query) {
            const selectedIdsValue = document.getElementById('selected-ids').value;
            fetch(`{% url 'questions' %}?q=${query}&selected_ids=${selectedIdsValue}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(data => {
                document.getElementById('search-results').innerHTML = data;
                restoreSelectedQuestions();
            })
            .catch(error => console.error('Error:', error));
        }

        if (document.getElementById('selected-questions')) {
            console.log('Initializing drag and drop for questions');
            initializeDragAndDrop('.question', 'available-questions', 'selected-questions');
            restoreSelectedQuestions();
        } else if (document.getElementById('selected-documents')) {
            console.log('Initializing drag and drop for documents');
            initializeDragAndDrop('.document', 'available-documents', 'selected-documents');
        }

        document.getElementById('search-form').addEventListener('submit', function(event) {
            event.preventDefault();
            saveSelectedQuestions();
            const query = this.querySelector('input[name="q"]').value;
            performSearch(query);
        });
    });
</script>
{% endblock %}
