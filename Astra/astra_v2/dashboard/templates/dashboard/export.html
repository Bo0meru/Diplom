{% extends "home/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/drag_and_drop.css' %}">
<style>
/* –ü—Ä–∏–º–µ—Ä –±–∞–∑–æ–≤—ã—Ö —Å—Ç–∏–ª–µ–π, —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ –æ—Ç–¥–µ–ª—è—Ç—å –∑–æ–Ω—ã */
.questions-page-container {
    display: flex;
    gap: 2rem;
    margin: 20px;
}
.bank-questions, .export-bank {
    flex: 1;
    border: 2px dashed #ccc;
    padding: 10px;
    min-height: 300px;
    position: relative;
}
.bank-questions h2, .export-bank h2 {
    margin-top: 0;
}
.question-item {
    background: #f0f0f0;
    margin: 5px 0;
    padding: 10px;
    cursor: grab;
    border: 1px solid #ccc;
}
.question-item.dragging {
    opacity: 0.5;     /* –ü—Ä–∏–º–µ—Ä "–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏" –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
    border-color: #999;
}
</style>
{% endblock extra_css %}

{% block content %}
<div class="questions-page-container">

    <!-- –ë–∞–Ω–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ (–ª–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞) -->
    <div class="bank-questions" id="bank-questions">
        <h2>–ë–∞–Ω–∫ –≤–æ–ø—Ä–æ—Å–æ–≤</h2>
        <div id="questions-list">
            {% for question in questions %}
            <div
                class="question-item"
                draggable="true"
                data-id="{{ question.id }}"
                data-tags="{{ question.tags.values_list|join:',' }}">
                {{ question.text }}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –í—ã–≥—Ä—É–∂–∞–µ–º—ã–π –±–∞–Ω–∫ (–ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞) -->
    <div class="export-bank" id="export-bank">
        <h2>–í—ã–≥—Ä—É–∂–∞–µ–º—ã–π –±–∞–Ω–∫</h2>
        <div id="export-list"></div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –º–µ—Ç–∫–∞–º (–º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≥–¥–µ —É–≥–æ–¥–Ω–æ, –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏) -->
    <div class="tags-container">
        <h2>–§–∏–ª—å—Ç—Ä –ø–æ –º–µ—Ç–∫–∞–º</h2>
        <input type="text" id="tags-search-bar" class="tags-search-bar" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –º–µ—Ç–∫–∞–º...">
        <div id="tags-grid" class="tags-grid">
            {% for tag in all_tags %}
            <div class="tag-item">
                <label>
                    <input type="checkbox" class="tag-checkbox" data-id="{{ tag.id }}">
                    {{ tag.name }}
                </label>
            </div>
            {% endfor %}
        </div>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ -->
<div class="export-button-container" style="margin: 0 20px; z-index: 2;">
    <button id="export-button" class="btn-save">–í—ã–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã</button>
</div>
</div>



{% endblock content %}

{% block extra_js %}
<script>
// --------------------- DRAG & DROP –õ–û–ì–ò–ö–ê ---------------------
document.addEventListener('DOMContentLoaded', function() {
    const questionsList = document.getElementById('questions-list');
    const exportList = document.getElementById('export-list');
    const exportButton = document.getElementById('export-button');

    // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –≤—Å–µ .question-item (–Ω–∞—á–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫)
    document.querySelectorAll('.question-item').forEach(item => {
        item.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
            e.target.classList.add('dragging');
        });
        item.addEventListener('dragend', e => {
            e.target.classList.remove('dragging');
        });
    });

    // –§—É–Ω–∫—Ü–∏—è, —Ä–∞–∑—Ä–µ—à–∞—é—â–∞—è —Å–±—Ä–æ—Å –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    function enableDropZone(dropZone) {
        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
        });
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            const questionId = e.dataTransfer.getData('text/plain');
            const draggedElement = document.querySelector(`.question-item[data-id='${questionId}']`);
            if (draggedElement && !dropZone.contains(draggedElement)) {
                dropZone.appendChild(draggedElement);
            }
        });
    }
    enableDropZone(questionsList);
    enableDropZone(exportList);

    // --------------------- –í–´–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –í–û–ü–†–û–°–û–í ---------------------
    exportButton.addEventListener('click', function() {
        // –°–æ–±–µ—Ä—ë–º –≤—Å–µ data-id –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ "–í—ã–≥—Ä—É–∂–∞–µ–º–æ–º –±–∞–Ω–∫–µ"
        const exportedItems = exportList.querySelectorAll('.question-item');
        const questionIds = Array.from(exportedItems).map(item => item.dataset.id);

        if (questionIds.length === 0) {
            alert('–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏!');
            return;
        }

        // –î–µ–ª–∞–µ–º POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç "export_to_docx" (–Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å)
        // –∏ –ø–µ—Ä–µ–¥–∞—ë–º –º–∞—Å—Å–∏–≤ ID.
        // –ü–æ –∏—Ç–æ–≥—É —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—ë—Ç docx-—Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.
        fetch("{% url 'export_to_docx' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',  // –Ω–µ –∑–∞–±—É–¥—å—Ç–µ, –µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω CSRF
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ question_ids: questionIds })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞.');
            }
            // –ß—Ç–æ–±—ã —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª, –Ω—É–∂–Ω–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –æ—Ç–≤–µ—Ç –≤ blob –∏ —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–µ–≥–æ
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // –ò–º—è —Ñ–∞–π–ª–∞, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç —É —Å–∫–∞—á–∏–≤–∞–µ–º–æ–≥–æ docx
            a.download = 'exported_questions.docx';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error(error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
        });
    });
});
</script>
{% endblock extra_js %}
